{% extends "auctions/layout.html" %}

{% block body %}

<div class="container mt-4 listing-detail-container">

    <!-- TITLE + CATEGORY -->
    <h2 class="listing-title">{{ item.name }}</h2>
    <p class="text-muted">
        Category: <strong>{{ item.get_category_display }}</strong>
    </p>

    <!-- IMAGE -->
    <div class="listing-image-container mb-4">
        {% if item.image %}
            <img src="{{ item.image.url }}" class="listing-detail-img" alt="{{ item.name }}">
        {% else %}
            <div class="no-image-large">
                üì¶ No Image Available
            </div>
        {% endif %}
    </div>

    <div class="listing-detail-card">

        <!-- MAIN INFO -->
        <div class="listing-info">

            <div class="info-item">
                <div class="info-label">Listed By</div>
                <div class="info-value">{{ item.owner.username }}</div>
            </div>

            <div class="info-item">
                <div class="info-label">Starting Bid</div>
                <div class="info-value">‚Çπ{{ item.starting_bid }}</div>
            </div>

            <div class="info-item">
                <div class="info-label">Current Highest Bid</div>
                <div class="info-value">
                    {% if highest_bid %}
                        ‚Çπ{{ highest_bid.amount }} ({{ highest_bid.bidder.username }})
                    {% else %}
                        No bids yet
                    {% endif %}
                </div>
            </div>

            <div class="info-item">
                <div class="info-label">Description</div>
                <div class="info-value description">{{ item.description }}</div>
            </div>

            {% if not item.bid_open %}
                <div class="alert alert-info mt-2">
                    <strong>Auction Closed</strong><br>
                    {% if item.winner %}
                        Winner: <strong>{{ item.winner.username }}</strong><br>
                        Winning Bid: ‚Çπ{{ item.ending_bid }}
                    {% else %}
                        No bids were placed.
                    {% endif %}
                </div>
            {% endif %}
        </div>

        <!-- OWNER: CLOSE AUCTION -->
        {% if user.is_authenticated and user == item.owner and item.bid_open %}
            <form action="{% url 'close_auction' item.id %}" method="POST" class="mb-4">
                {% csrf_token %}
                <button type="submit" class="btn btn-warning w-100">
                    Close Auction
                </button>
            </form>
        {% endif %}

        <!-- COMMENTS SECTION -->
        <h4>Comments</h4>
        <ul class="list-group mb-4">
            {% for c in comments %}
            <li class="list-group-item">
                <div class="comment-author">{{ c.user.username }}</div>
                <div class="comment-text">{{ c.comment }}</div>
            </li>
            {% empty %}
            <li class="list-group-item text-muted">No comments yet.</li>
            {% endfor %}
        </ul>

        {% if user.is_authenticated %}
        <!-- ADD COMMENT -->
        <form action="{% url 'comment' %}" method="POST" class="mb-4">
            {% csrf_token %}
            <textarea name="comment" class="form-control mb-2" placeholder="Write a comment..." required></textarea>
            <input type="hidden" name="listing_id" value="{{ item.id }}">
            <button type="submit" class="btn btn-primary w-100">Post Comment</button>
        </form>
        {% endif %}

        <!-- BID FORM -->
        <div id="bidform"></div>
        {% if item.bid_open %}
        <h4>Place Your Bid</h4>
        <form action="{% url 'bid' %}" method="POST" class="mb-4">
            {% csrf_token %}
            <input type="hidden" name="listing_id" value="{{ item.id }}">
            <input type="number" step="0.01" name="bid_value" class="form-control mb-2"
                   placeholder="Enter your bid amount" required>
            <button type="submit" class="btn btn-success w-100">Place Bid</button>
        </form>
        {% else %}
        <div class="alert alert-secondary text-center mb-4">
            üö´ Bidding is closed.
        </div>
        {% endif %}

        <!-- WATCHLIST -->
        {% if user.is_authenticated %}
        <h4>Watchlist</h4>
        <form action="{% url 'watch_toggle' %}" method="POST">
            {% csrf_token %}
            <input type="hidden" name="listing_id" value="{{ item.id }}">
            <button class="btn btn-outline-danger w-100" type="submit">
                {% if in_watchlist %}
                    ‚ù§Ô∏è Remove from Watchlist
                {% else %}
                    ü§ç Add to Watchlist
                {% endif %}
            </button>
        </form>
        {% endif %}

    </div>
</div>

{% endblock %}
